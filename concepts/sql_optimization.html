<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Optimizing Queries - Firefox Data Documentation</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../dtmo.css">
        
        <link rel="stylesheet" href="../mermaid.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Firefox Data Documentation</a></li><li class="chapter-item expanded "><a href="../concepts/getting_started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/gaining_access.html"><strong aria-hidden="true">1.1.</strong> Gaining Access</a></li><li class="chapter-item expanded "><a href="../concepts/analysis_intro.html"><strong aria-hidden="true">1.2.</strong> Analysis Quick Start</a></li><li class="chapter-item expanded "><a href="../metrics/intro.html"><strong aria-hidden="true">1.3.</strong> Intro to Metrics</a></li><li class="chapter-item expanded "><a href="../concepts/analysis_gotchas.html"><strong aria-hidden="true">1.4.</strong> Common Analysis Gotchas</a></li><li class="chapter-item expanded "><a href="../concepts/choosing_a_dataset.html"><strong aria-hidden="true">1.5.</strong> Choosing a Desktop Dataset</a></li><li class="chapter-item expanded "><a href="../concepts/choosing_a_dataset_mobile.html"><strong aria-hidden="true">1.6.</strong> Choosing a Mobile Dataset</a></li><li class="chapter-item expanded "><a href="../concepts/glean/glean.html"><strong aria-hidden="true">1.7.</strong> Glean overview</a></li><li class="chapter-item expanded "><a href="../tools/stmo.html"><strong aria-hidden="true">1.8.</strong> Intro to STMO</a></li><li class="chapter-item expanded "><a href="../concepts/sql_optimization.html" class="active"><strong aria-hidden="true">1.9.</strong> Optimizing Queries</a></li><li class="chapter-item expanded "><a href="../concepts/terminology.html"><strong aria-hidden="true">1.10.</strong> Terminology</a></li><li class="chapter-item expanded "><a href="../concepts/getting_help.html"><strong aria-hidden="true">1.11.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="../concepts/reporting_a_problem.html"><strong aria-hidden="true">1.12.</strong> Reporting a problem</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/index.html"><strong aria-hidden="true">2.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/projects.html"><strong aria-hidden="true">2.1.</strong> Project Glossary</a></li><li class="chapter-item expanded "><a href="../tools/guiding_principles.html"><strong aria-hidden="true">2.2.</strong> Guiding Principles for Data Infrastructure</a></li><li class="chapter-item expanded "><a href="../concepts/pipeline/gcp_data_pipeline.html"><strong aria-hidden="true">2.3.</strong> Overview of Mozilla's Data Pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/pipeline/http_edge_spec.html"><strong aria-hidden="true">2.3.1.</strong> HTTP Edge Server Specification</a></li><li class="chapter-item expanded "><a href="../concepts/pipeline/event_pipeline.html"><strong aria-hidden="true">2.3.2.</strong> Event Pipeline Detail</a></li><li class="chapter-item expanded "><a href="../concepts/pipeline/schemas.html"><strong aria-hidden="true">2.3.3.</strong> Schemas</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/interfaces.html"><strong aria-hidden="true">2.4.</strong> Analysis Interfaces</a></li><li class="chapter-item expanded "><a href="../tools/spark.html"><strong aria-hidden="true">2.5.</strong> Custom analysis with Spark</a></li><li class="chapter-item expanded "><a href="../concepts/sql_style.html"><strong aria-hidden="true">2.6.</strong> SQL Style Guide</a></li><li class="chapter-item expanded "><a href="../tools/gud.html"><strong aria-hidden="true">2.7.</strong> Growth &amp; Usage Dashboard (GUD)</a></li></ol></li><li class="chapter-item expanded "><a href="../metrics/index.html"><strong aria-hidden="true">3.</strong> Metrics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../metrics/definitions.html"><strong aria-hidden="true">3.1.</strong> Definitions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../metrics/metrics.html"><strong aria-hidden="true">3.1.1.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="../metrics/usage.html"><strong aria-hidden="true">3.1.2.</strong> Usage Criteria</a></li><li class="chapter-item expanded "><a href="../metrics/dimensions.html"><strong aria-hidden="true">3.1.3.</strong> Slicing Dimensions</a></li></ol></li><li class="chapter-item expanded "><a href="../metrics/policy.html"><strong aria-hidden="true">3.2.</strong> Metrics Standardization and Policy</a></li></ol></li><li class="chapter-item expanded "><a href="../cookbooks/index.html"><strong aria-hidden="true">4.</strong> Analysis cookbooks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/bigquery.html"><strong aria-hidden="true">4.1.</strong> Accessing and working with BigQuery</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/bigquery/access.html"><strong aria-hidden="true">4.1.1.</strong> Accessing BigQuery</a></li><li class="chapter-item expanded "><a href="../cookbooks/bigquery/querying.html"><strong aria-hidden="true">4.1.2.</strong> Writing BigQuery Queries</a></li><li class="chapter-item expanded "><a href="../cookbooks/bigquery/optimization.html"><strong aria-hidden="true">4.1.3.</strong> Optimizing BigQuery Queries</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/glean/accessing_glean_data.html"><strong aria-hidden="true">4.2.</strong> Accessing Glean data</a></li><li class="chapter-item expanded "><a href="../cookbooks/dataset_specific.html"><strong aria-hidden="true">4.3.</strong> Dataset Specific</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/normandy_events.html"><strong aria-hidden="true">4.3.1.</strong> Working with Normandy events</a></li><li class="chapter-item expanded "><a href="../cookbooks/crash_pings.html"><strong aria-hidden="true">4.3.2.</strong> Working with Crash Pings</a></li><li class="chapter-item expanded "><a href="../cookbooks/clients_last_seen_bits.html"><strong aria-hidden="true">4.3.3.</strong> Working with Bit Patterns in Clients Last Seen</a></li></ol></li><li class="chapter-item expanded "><a href="../cookbooks/realtime.html"><strong aria-hidden="true">4.4.</strong> Real-time</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/view_pings_cep.html"><strong aria-hidden="true">4.4.1.</strong> Seeing Your Own Pings</a></li></ol></li><li class="chapter-item expanded "><a href="../cookbooks/metrics.html"><strong aria-hidden="true">4.5.</strong> Metrics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/dau.html"><strong aria-hidden="true">4.5.1.</strong> Daily Active Users (DAU and MAU)</a></li><li class="chapter-item expanded "><a href="../cookbooks/active_dau.html"><strong aria-hidden="true">4.5.2.</strong> Active DAU (aDAU)</a></li><li class="chapter-item expanded "><a href="../cookbooks/retention.html"><strong aria-hidden="true">4.5.3.</strong> Retention</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../cookbooks/index.html"><strong aria-hidden="true">5.</strong> Operational cookbooks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/gcp-projects.html"><strong aria-hidden="true">5.1.</strong> Creating a Prototype Data Project on Google Cloud Platform</a></li><li class="chapter-item expanded "><a href="../cookbooks/bigquery-airflow.html"><strong aria-hidden="true">5.2.</strong> Scheduling BigQuery Queries in Airflow</a></li><li class="chapter-item expanded "><a href="../cookbooks/deploying-containers.html"><strong aria-hidden="true">5.3.</strong> Building and Deploying Containers to GCR with CircleCI</a></li><li class="chapter-item expanded "><a href="../public_data/publishing_datasets.html"><strong aria-hidden="true">5.4.</strong> Publishing Datasets</a></li></ol></li><li class="chapter-item expanded "><a href="../datasets/new_data.html"><strong aria-hidden="true">6.</strong> Sending telemetry</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbooks/client_guidelines.html"><strong aria-hidden="true">6.1.</strong> Implementing Experiments</a></li><li class="chapter-item expanded "><a href="../cookbooks/events_best_practices.html"><strong aria-hidden="true">6.2.</strong> Sending Events</a></li><li class="chapter-item expanded "><a href="../cookbooks/new_ping.html"><strong aria-hidden="true">6.3.</strong> Sending a Custom Ping</a></li></ol></li><li class="chapter-item expanded "><a href="../public_data/index.html"><strong aria-hidden="true">7.</strong> Public data</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../datasets/reference.html"><strong aria-hidden="true">8.</strong> Dataset Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/pings.html"><strong aria-hidden="true">8.1.</strong> Pings</a></li><li class="chapter-item expanded "><a href="../datasets/derived.html"><strong aria-hidden="true">8.2.</strong> Derived Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/active_profiles.html"><strong aria-hidden="true">8.2.1.</strong> Active Profiles</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/addons/reference.html"><strong aria-hidden="true">8.2.2.</strong> Addons</a></li><li class="chapter-item expanded "><a href="../datasets/other/addons_daily/reference.html"><strong aria-hidden="true">8.2.3.</strong> Addons Daily</a></li><li class="chapter-item expanded "><a href="../datasets/other/asn_aggregates/reference.html"><strong aria-hidden="true">8.2.4.</strong> AS aggregates</a></li><li class="chapter-item expanded "><a href="../datasets/other/attitudes_daily/reference.html"><strong aria-hidden="true">8.2.5.</strong> Attitudes Daily</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/clients_daily/reference.html"><strong aria-hidden="true">8.2.6.</strong> Clients Daily</a></li><li class="chapter-item expanded "><a href="../datasets/bigquery/clients_last_seen/reference.html"><strong aria-hidden="true">8.2.7.</strong> Clients Last Seen</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/events/reference.html"><strong aria-hidden="true">8.2.8.</strong> Events</a></li><li class="chapter-item expanded "><a href="../datasets/bigquery/exact_mau/reference.html"><strong aria-hidden="true">8.2.9.</strong> Exact MAU</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/first_shutdown_summary/reference.html"><strong aria-hidden="true">8.2.10.</strong> First Shutdown Summary</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/main_summary/reference.html"><strong aria-hidden="true">8.2.11.</strong> Main Summary</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/new_profile/reference.html"><strong aria-hidden="true">8.2.12.</strong> New Profile</a></li><li class="chapter-item expanded "><a href="../datasets/other/socorro_crash/reference.html"><strong aria-hidden="true">8.2.13.</strong> Socorro Crash Reports</a></li><li class="chapter-item expanded "><a href="../datasets/other/ssl/reference.html"><strong aria-hidden="true">8.2.14.</strong> SSL Ratios (public)</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/telemetry_aggregates/reference.html"><strong aria-hidden="true">8.2.15.</strong> Telemetry Aggregates</a></li><li class="chapter-item expanded "><a href="../datasets/batch_view/update/reference.html"><strong aria-hidden="true">8.2.16.</strong> Update</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/experiments.html"><strong aria-hidden="true">8.3.</strong> Experimental Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/heartbeat.html"><strong aria-hidden="true">8.3.1.</strong> Accessing Heartbeat data</a></li><li class="chapter-item expanded "><a href="../datasets/shield.html"><strong aria-hidden="true">8.3.2.</strong> Accessing Shield Study data</a></li><li class="chapter-item expanded "><a href="../datasets/dynamic_telemetry.html"><strong aria-hidden="true">8.3.3.</strong> Dynamic telemetry</a></li></ol></li><li class="chapter-item expanded "><a href="../datasets/search.html"><strong aria-hidden="true">8.4.</strong> Search Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/search/search_aggregates/reference.html"><strong aria-hidden="true">8.4.1.</strong> Search Aggregates</a></li><li class="chapter-item expanded "><a href="../datasets/search/search_clients_daily/reference.html"><strong aria-hidden="true">8.4.2.</strong> Search Clients Daily</a></li><li class="chapter-item expanded "><a href="../datasets/search/search_clients_last_seen/reference.html"><strong aria-hidden="true">8.4.3.</strong> Search Clients Last Seen</a></li></ol></li><li class="chapter-item expanded "><a href="../datasets/other.html"><strong aria-hidden="true">8.5.</strong> Other Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/other/hgpush/reference.html"><strong aria-hidden="true">8.5.1.</strong> hgpush</a></li><li class="chapter-item expanded "><a href="../datasets/other/stub_installer/reference.html"><strong aria-hidden="true">8.5.2.</strong> Stub installer ping</a></li><li class="chapter-item expanded "><a href="../datasets/other/activity-stream/reference.html"><strong aria-hidden="true">8.5.3.</strong> Activity Stream</a></li><li class="chapter-item expanded "><a href="../datasets/other/bmobugs/reference.html"><strong aria-hidden="true">8.5.4.</strong> bmobugs</a></li></ol></li><li class="chapter-item expanded "><a href="../datasets/fxa.html"><strong aria-hidden="true">8.6.</strong> Firefox Accounts Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/fxa_metrics/attribution.html"><strong aria-hidden="true">8.6.1.</strong> Firefox Account Attribution</a></li><li class="chapter-item expanded "><a href="../datasets/fxa_metrics/funnels.html"><strong aria-hidden="true">8.6.2.</strong> Firefox Account Funnel Metrics</a></li><li class="chapter-item expanded "><a href="../datasets/fxa_metrics/emails.html"><strong aria-hidden="true">8.6.3.</strong> Firefox Account Email Metrics</a></li></ol></li><li class="chapter-item expanded "><a href="../datasets/static.html"><strong aria-hidden="true">8.7.</strong> Static Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/static/normalized_os.html"><strong aria-hidden="true">8.7.1.</strong> Normalized OS Names And Versions</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../concepts/index.html"><strong aria-hidden="true">9.</strong> Telemetry Behavior Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/history.html"><strong aria-hidden="true">9.1.</strong> History of Telemetry</a></li><li class="chapter-item expanded "><a href="../concepts/profile/index.html"><strong aria-hidden="true">9.2.</strong> Profile Behavior</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/profile/profile_creation.html"><strong aria-hidden="true">9.2.1.</strong> Profile Creation</a></li><li class="chapter-item expanded "><a href="../concepts/profile/realworldusage.html"><strong aria-hidden="true">9.2.2.</strong> Real World Usage</a></li><li class="chapter-item expanded "><a href="../concepts/profile/profilehistory.html"><strong aria-hidden="true">9.2.3.</strong> Profile History</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/channels/index.html"><strong aria-hidden="true">9.3.</strong> Channel Behavior</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/channels/channel_normalization.html"><strong aria-hidden="true">9.3.1.</strong> Channel Normalization and Querying</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/censuses.html"><strong aria-hidden="true">9.4.</strong> Census metrics</a></li><li class="chapter-item expanded "><a href="../concepts/engagement.html"><strong aria-hidden="true">9.5.</strong> Engagement metrics</a></li><li class="chapter-item expanded "><a href="../concepts/segments.html"><strong aria-hidden="true">9.6.</strong> Segments</a></li><li class="chapter-item expanded "><a href="../concepts/sample_id.html"><strong aria-hidden="true">9.7.</strong> Sampling</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../historical/index.html"><strong aria-hidden="true">10.</strong> Historical Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/pipeline/data_pipeline.html"><strong aria-hidden="true">10.1.</strong> Previous AWS Pipeline Overview</a></li><li class="chapter-item expanded "><a href="../concepts/pipeline/data_pipeline_detail.html"><strong aria-hidden="true">10.2.</strong> In-depth AWS Data Pipeline Detail</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete.html"><strong aria-hidden="true">10.3.</strong> Obsolete Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../datasets/obsolete/churn/reference.html"><strong aria-hidden="true">10.3.1.</strong> Churn</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/client_count/reference.html"><strong aria-hidden="true">10.3.2.</strong> Client Count</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/client_count_daily/reference.html"><strong aria-hidden="true">10.3.3.</strong> Client Count Daily</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/crash_aggregates/reference.html"><strong aria-hidden="true">10.3.4.</strong> Crash Aggregates</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/crash_summary/reference.html"><strong aria-hidden="true">10.3.5.</strong> Crash Summary</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/error_aggregates/reference.html"><strong aria-hidden="true">10.3.6.</strong> Error Aggregates</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/heavy_users/reference.html"><strong aria-hidden="true">10.3.7.</strong> Heavy Users</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/longitudinal/reference.html"><strong aria-hidden="true">10.3.8.</strong> Longitudinal</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/retention/reference.html"><strong aria-hidden="true">10.3.9.</strong> Retention</a></li><li class="chapter-item expanded "><a href="../datasets/obsolete/sync_summary/reference.html"><strong aria-hidden="true">10.3.10.</strong> Sync Summary</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../meta/index.html"><strong aria-hidden="true">11.</strong> About this Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../meta/contributing.html"><strong aria-hidden="true">11.1.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../meta/structure.html"><strong aria-hidden="true">11.2.</strong> Structure</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Firefox Data Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/mozilla/firefox-data-docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#optimizing-sql-queries" id="optimizing-sql-queries">Optimizing SQL Queries</a></h1>
<p>After you write a query in <a href="https://sql.telemetry.mozilla.org">STMO</a>, you can make big steps to improve performance by
understanding how data is stored, what databases are doing under the covers, and what you can change about your query to
take advantage of those two pieces.</p>
<h2><a class="header" href="#tldr-what-to-do-for-quick-improvements" id="tldr-what-to-do-for-quick-improvements">TL;DR: What to do for quick improvements</a></h2>
<ul>
<li>Filter on a partitioned column† (<em>even</em> if you have a <code>LIMIT</code>)</li>
<li>Use a sample of the data based on the <code>sample_id</code> field. This can be helpful
for initial development, even if you later run the query using the entire
population (without sampling).</li>
<li>Select only the columns you want explicitly (Don't use <code>SELECT *</code>)</li>
<li>Use approximate algorithms: e.g. <code>approx_distinct(...)</code> instead of <code>COUNT(DISTINCT ...)</code></li>
</ul>
<p>† For legacy Parquet datasets, partitioned columns could be identified in the Schema Explorer in <a href="https://sql.telemetry.mozilla.org">re:dash</a>;
they were the first few columns under a table name, preceded by a <code>[P]</code>.
For BigQuery, the terminology is a bit different and re:dash does not yet show partitioning information in the Schema Explorer,
but many tables are partitioned on <code>submission_timestamp</code> or <code>submission_date</code> fields
and <em>clustered</em> on <code>normalized_channel</code> and <code>sample_id</code>;
you can usually get query efficiency gains by filtering on any of those fields as discussed in
another article about <a href="../cookbooks/bigquery/optimization.html">BigQuery-specific Query Optimization</a>.</p>
<h2><a class="header" href="#some-explanations" id="some-explanations">Some Explanations</a></h2>
<p>There are a few key things to understand about our data storage and these databases to
learn how to properly optimize queries.</p>
<h3><a class="header" href="#what-are-these-databases" id="what-are-these-databases">What are these databases?</a></h3>
<p>The databases we use are not traditional relational databases like PostgreSQL or MySQL.
They are distributed SQL engines, where the data is stored separately from the compute resources.
They include multiple machines all working together in a coordinated fashion.</p>
<h4><a class="header" href="#how-does-this-impact-my-queries" id="how-does-this-impact-my-queries">How does this impact my queries?</a></h4>
<p>What that means is that multiple machines will be working together to get the result of your
query. Because there is more than one machine, we worry a lot about <em>Data Shuffles</em>: when all
of the machines have to send data around to all of the other machines.</p>
<p>For example, consider the following query, which gives the number of rows present for each
<code>client_id</code>:</p>
<pre><code>SELECT client_id, COUNT(*)
FROM telemetry.main
GROUP BY client_id
</code></pre>
<p>The steps that would happen are this:</p>
<ol>
<li>Each machine reads a different piece of the data, and parses out the <code>client_id</code> for
each row. Internally, it then computes the number of rows seen for each <code>client_id</code>,
<em>but only for the data that it read</em>.</li>
<li>Each machine is then given a set of <code>client_id</code>s to aggregate. For example, the first
machine may be told to get the count of <code>client1</code>. It will then have to ask every other
machine for the total seen for <code>client1</code>. It can then aggregate the total.</li>
<li>Given that every <code>client_id</code> has now been aggregated, each machine reports to the coordinator
the <code>client_id</code>s that it was responsible for, as well as the count of rows seen for each.
The coordinator is responsible for returning the result of the query to the client,
which in our example is STMO.</li>
</ol>
<p>A similar process happens on data joins, where different machines are told to join on
different keys. In that case, data from both tables needs to be shuffled to every machine.</p>
<h4><a class="header" href="#key-takeaways" id="key-takeaways">Key Takeaways</a></h4>
<ul>
<li>Use <code>LIMIT</code> for query prototyping. This can dramatically reduce the amount of data scanned
as well as speeding things up.</li>
<li>Use approximate algorithms. These mean less data needs to be shuffled, since we can use
probabilistic data structures instead of the raw data itself.</li>
<li>Specify large tables first in a <code>JOIN</code> operation. In this case, small tables can be sent to
every machine, eliminating one data shuffle operation. Note that Spark supports a <code>broadcast</code>
command explicitly.</li>
</ul>
<h3><a class="header" href="#how-is-the-data-stored" id="how-is-the-data-stored">How is the data stored?</a></h3>
<p>The data is stored in columnar format. Let's try and understand that with an example.</p>
<h4><a class="header" href="#traditional-row-stores" id="traditional-row-stores">Traditional Row Stores</a></h4>
<p>Consider a completely normal CSV file, which is actually an example of a row store.</p>
<pre><code>name,age,height
&quot;Ted&quot;,27,6.0
&quot;Emmanuel&quot;,45,5.9
&quot;Cadence&quot;,5,3.5
</code></pre>
<p>When this data is stored to disk, you could read an entire record in a consecutive order. For example if
the first <code>&quot;</code> was stored at block 1 on disk, then a sequential scan from 1 will give the first row of
data: <code>&quot;ted&quot;,27,6.0</code>. Keep scanning and you'll get <code>\n&quot;Emm</code>... and so on.</p>
<p>So for the above, the following query will be fast:</p>
<pre><code>SELECT *
FROM people
WHERE name == 'Ted'
</code></pre>
<p>Since the database can just scan the first row of data. However, the following is more difficult:</p>
<pre><code>SELECT name
FROM people
</code></pre>
<p>Now the database has to read <em>all</em> of the rows, and then pick out the <code>name</code> column. This is a lot
more overhead!</p>
<h4><a class="header" href="#columnar-stores" id="columnar-stores">Columnar Stores</a></h4>
<p>Columnar turns the data sideways. For example, we can make a columnar version of the above data,
and still store it in CSV:</p>
<pre><code>name,&quot;Ted&quot;,&quot;Emmanuel&quot;,&quot;Cadence&quot;
age,27,45,5
height,6.0,5.9,3.5
</code></pre>
<p>Pretty easy! Now let's consider how we can query the data when it's stored this way.</p>
<pre><code>SELECT *
FROM people
WHERE name == &quot;ted&quot;
</code></pre>
<p>This query is pretty hard! We have to read all of the data now, because the
<code>(name, age, height)</code> isn't stored together.</p>
<p>Now let's consider our other query:</p>
<pre><code>SELECT name
FROM people
</code></pre>
<p>Suddenly, this is easy! We don't have to check in as many places for data,
we can just read the first few blocks of disks sequentially.</p>
<h4><a class="header" href="#data-partitions" id="data-partitions">Data Partitions</a></h4>
<p>We can improve performance even further by taking advantage of partitions. These are entire files of data
that share a value for a column. So for example, if everyone in the <code>people</code> table lived in <code>DE</code>, then we
could add that to the filename: <code>/country=DE/people.csv</code>.</p>
<p>From there, our query engine would have to know how to read that path, and understand that it's telling us
that all of those people share a country. So if we were to query for this:</p>
<pre><code>SELECT *
FROM people
WHERE country == 'US'
</code></pre>
<p>The database wouldn't have to even read the file! It could just look at the path and realize there was
nothing of interest.</p>
<p>Our tables are usually partitioned by date, e.g. <code>submission_date</code> or <code>DATE(submission_timestamp)</code>.</p>
<h4><a class="header" href="#key-takeaways-1" id="key-takeaways-1">Key Takeaways</a></h4>
<ul>
<li>Limit queries to a specific few columns you need, to reduce the amount of data that has to be read</li>
<li>Filter on partitions to prune down the data you need</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/firefox-data-docs/edit/master/src/concepts/sql_optimization.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../tools/stmo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../concepts/terminology.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../tools/stmo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../concepts/terminology.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-104326577-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../mermaid-init.js"></script>
        

        

    </body>
</html>
