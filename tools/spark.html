
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Custom analysis with Spark Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../cookbooks/realtime_analysis_plugin.html" />
    
    
    <link rel="prev" href="../concepts/analysis_intro.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Firefox Data Documentation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../concepts/terminology.html">
            
                <a href="../concepts/terminology.html">
            
                    
                    Terminology
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../concepts/getting_started.html">
            
                <a href="../concepts/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../concepts/analysis_intro.html">
            
                <a href="../concepts/analysis_intro.html">
            
                    
                    Analysis Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../concepts/data_privacy.html">
            
                <a href="../concepts/data_privacy.html">
            
                    
                    Data Privacy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../concepts/choosing_a_dataset.html">
            
                <a href="../concepts/choosing_a_dataset.html">
            
                    
                    Choosing a Dataset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="stmo.html">
            
                <a href="stmo.html">
            
                    
                    Intro to STMO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../concepts/analysis_gotchas.html">
            
                <a href="../concepts/analysis_gotchas.html">
            
                    
                    Common Analysis Gotchas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../concepts/review.html">
            
                <a href="../concepts/review.html">
            
                    
                    Getting Review
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../datasets/">
            
                <a href="../datasets/">
            
                    
                    Data Collection and Datasets
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" >
            
                <span>
            
                    
                    Understanding our Data
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../concepts/choosing_a_dataset.html">
            
                <a href="../concepts/choosing_a_dataset.html">
            
                    
                    Choosing a dataset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../concepts/analysis_gotchas.html">
            
                <a href="../concepts/analysis_gotchas.html">
            
                    
                    Common Analysis Gotchas
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../datasets/new_data.html">
            
                <a href="../datasets/new_data.html">
            
                    
                    Collecting New Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../datasets/reference.html">
            
                <a href="../datasets/reference.html">
            
                    
                    Dataset Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="../datasets/pings.html">
            
                <a href="../datasets/pings.html">
            
                    
                    Pings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="../datasets/derived.html">
            
                <a href="../datasets/derived.html">
            
                    
                    Derived Datasets
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.2.1" data-path="../datasets/batch_view/longitudinal/reference.html">
            
                <a href="../datasets/batch_view/longitudinal/reference.html">
            
                    
                    Longitudinal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.2" data-path="../datasets/batch_view/cross_sectional/reference.html">
            
                <a href="../datasets/batch_view/cross_sectional/reference.html">
            
                    
                    Cross Sectional
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.3" data-path="../datasets/batch_view/main_summary/reference.html">
            
                <a href="../datasets/batch_view/main_summary/reference.html">
            
                    
                    Main Summary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.4" data-path="../datasets/batch_view/crash_summary/reference.html">
            
                <a href="../datasets/batch_view/crash_summary/reference.html">
            
                    
                    Crash Summary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.5" data-path="../datasets/batch_view/crash_aggregates/reference.html">
            
                <a href="../datasets/batch_view/crash_aggregates/reference.html">
            
                    
                    Crash Aggregate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.6" data-path="../datasets/batch_view/events/reference.html">
            
                <a href="../datasets/batch_view/events/reference.html">
            
                    
                    Events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.7" data-path="../datasets/batch_view/sync_summary/reference.html">
            
                <a href="../datasets/batch_view/sync_summary/reference.html">
            
                    
                    Sync Summary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.8" data-path="../datasets/batch_view/addons/reference.html">
            
                <a href="../datasets/batch_view/addons/reference.html">
            
                    
                    Addons
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.9" data-path="../datasets/batch_view/client_count/reference.html">
            
                <a href="../datasets/batch_view/client_count/reference.html">
            
                    
                    Client Count
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.10" data-path="../datasets/batch_view/new_profile/reference.html">
            
                <a href="../datasets/batch_view/new_profile/reference.html">
            
                    
                    New Profile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2.11" data-path="../datasets/batch_view/update/reference.html">
            
                <a href="../datasets/batch_view/update/reference.html">
            
                    
                    Update
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="experiments.html">
            
                <a href="experiments.html">
            
                    
                    Experimental Datasets
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.3.1" data-path="../datasets/shield.html">
            
                <a href="../datasets/shield.html">
            
                    
                    Accessing Shield Study data
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Tools
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../concepts/data_pipeline.html">
            
                <a href="../concepts/data_pipeline.html">
            
                    
                    Overview of Mozilla's Data Pipeline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="interfaces.html">
            
                <a href="interfaces.html">
            
                    
                    Interfaces
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../concepts/analysis_intro.html">
            
                <a href="../concepts/analysis_intro.html">
            
                    
                    Analysis Intro / TMO
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.2.2" data-path="spark.html">
            
                <a href="spark.html">
            
                    
                    Custom analysis with Spark
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.3" data-path="../cookbooks/realtime_analysis_plugin.html">
            
                <a href="../cookbooks/realtime_analysis_plugin.html">
            
                    
                    Creating a Real-time Analysis Plugin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.4" data-path="distribution_viewer.html">
            
                <a href="distribution_viewer.html">
            
                    
                    Distribution Viewer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.5" data-path="hbase.html">
            
                <a href="hbase.html">
            
                    
                    HBase
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.6" data-path="rtmo.html">
            
                <a href="rtmo.html">
            
                    
                    RTMO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.7" data-path="alerts.html">
            
                <a href="alerts.html">
            
                    
                    Alerts
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../cookbooks/">
            
                <a href="../cookbooks/">
            
                    
                    Cookbooks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../cookbooks/parquet.html">
            
                <a href="../cookbooks/parquet.html">
            
                    
                    Working with Parquet Data on ATMO Clusters
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../cookbooks/create_a_dataset.html">
            
                <a href="../cookbooks/create_a_dataset.html">
            
                    
                    Creating a custom re:dash dataset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../cookbooks/realtime_analysis_plugin.html">
            
                <a href="../cookbooks/realtime_analysis_plugin.html">
            
                    
                    Creating a Real-time Analysis Plugin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../cookbooks/longitudinal_examples.html">
            
                <a href="../cookbooks/longitudinal_examples.html">
            
                    
                    Longitudinal Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    About this Documentation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../meta/contributing.html">
            
                <a href="../meta/contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" >
            
                <a target="_blank" href="https://bugzilla.mozilla.org/enter_bug.cgi?assigned_to=nobody%40mozilla.org&bug_file_loc=http%3A%2F%2F&bug_ignored=0&bug_severity=normal&bug_status=NEW&cf_fx_iteration=---&cf_fx_points=---&component=Documentation%20and%20Knowledge%20Repo%20%28RTMO%29&contenttypemethod=autodetect&contenttypeselection=text%2Fplain&defined_groups=1&flag_type-4=X&flag_type-607=X&flag_type-800=X&flag_type-803=X&flag_type-916=X&form_name=enter_bug&maketemplate=Remember%20values%20as%20bookmarkable%20template&op_sys=Linux&priority=P3&product=Data%20Platform%20and%20Tools&rep_platform=x86_64&target_milestone=---&version=unspecified">
            
                    
                    Bug Template
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../meta/structure.html">
            
                <a href="../meta/structure.html">
            
                    
                    Structure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Custom analysis with Spark</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="introduction"><a name="introduction" class="plugin-anchor" href="#introduction"><i class="fa fa-link" aria-hidden="true"></i></a>Introduction</h2>
<p><a href="http://spark.apache.org/" target="_blank">Spark</a>
is a data processing engine designed to be fast and easy to use.
We have setup
<a href="http://jupyter.org/" target="_blank">Jupyter notebooks</a>
that use Spark to analyze our Telemetry data.
Jupyter workbooks can be easily shared and updated among colleagues,
and, when combined with Spark, enable richer analysis than SQL alone.</p>
<p>The Spark clusters can be spun up on <a href="https://analysis.telemetry.mozilla.org" target="_blank">ATMO</a>.
The Spark Python API is called pyspark.</p>
<h2 id="setting-up-a-spark-cluster-on-atmo"><a name="setting-up-a-spark-cluster-on-atmo" class="plugin-anchor" href="#setting-up-a-spark-cluster-on-atmo"><i class="fa fa-link" aria-hidden="true"></i></a>Setting Up a Spark Cluster On ATMO</h2>
<ol>
<li>Go to <a href="http://analysis.telemetry.mozilla.org" target="_blank">http://analysis.telemetry.mozilla.org</a></li>
<li>Click &#x201C;Launch an ad-hoc Spark cluster&#x201D;.</li>
<li>Enter some details:<ol>
<li>The &#x201C;Cluster Name&#x201D; field should be a short descriptive name,
like &#x201C;chromehangs analysis&#x201D;.</li>
<li>Set the number of workers for the cluster. Please keep in mind
to use resources sparingly; use a single worker to write and
debug your job.</li>
<li>Upload your SSH public key.</li>
</ol>
</li>
<li>Click &#x201C;Submit&#x201D;.</li>
<li>A cluster will be launched on AWS preconfigured with Spark, IPython
and some handy data analysis libraries like pandas and matplotlib.</li>
</ol>
<p>Once the cluster is ready, you can tunnel IPython through SSH by
following the instructions on the dashboard.
For example:</p>
<pre><code class="lang-bash">ssh -i ~/.ssh/id_rsa -L 8888:localhost:8888 hadoop@ec2-54-70-129-221.us-west-2.compute.amazonaws.com
</code></pre>
<p>Finally, you can launch IPython in Firefox by visiting <a href="http://localhost:8888" target="_blank">http://localhost:8888</a>.</p>
<h2 id="the-python-jupyter-notebook"><a name="the-python-jupyter-notebook" class="plugin-anchor" href="#the-python-jupyter-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>The Python Jupyter Notebook</h2>
<p>When you access <a href="http://localhost:8888" target="_blank">http://localhost:8888</a>, two example Jupyter notebooks
are available to peruse.</p>
<p>Starting out, we recommend looking through the
<a href="https://github.com/mozilla/mozilla-reports/blob/master/tutorials/telemetry_hello_world.kp/orig_src/Telemetry%20Hello%20World.ipynb" target="_blank">Telemetry Hello World</a>
notebook.
It gives a nice overview of Jupyter and analyzing telemetry data using pyspark and the RDD API.</p>
<h3 id="using-jupyter"><a name="using-jupyter" class="plugin-anchor" href="#using-jupyter"><i class="fa fa-link" aria-hidden="true"></i></a>Using Jupyter</h3>
<p>Jupyter Notebooks contain a series of cells.
Each cell contains code or markdown.
To switch between the two, use the dropdown at the top.
To run a cell, use shift-enter;
this either compiles the markdown or runs the code.
To create new cell, select Insert -&gt; Insert Cell Below.</p>
<p>A cell can output text or plots.
To output plots inlined with the cell,
run <code>%pylab inline</code>, usually below your import statements:</p>
<p>The notebook is setup to work with Spark. See the &quot;Using Spark&quot; section
for more information.</p>
<h3 id="schedule-a-periodic-job"><a name="schedule-a-periodic-job" class="plugin-anchor" href="#schedule-a-periodic-job"><i class="fa fa-link" aria-hidden="true"></i></a>Schedule a periodic job</h3>
<p>Scheduled Spark jobs allow a Jupyter notebook to be updated consistently,
making a nice and easy-to-use dashboard.</p>
<p>To schedule a Spark job:</p>
<ol>
<li>Visit the analysis provisioning dashboard at
telemetry-dash.mozilla.org and sign in</li>
<li>Click &#x201C;Schedule a Spark Job&#x201D;</li>
<li>Enter some details:<ol>
<li>The &#x201C;Job Name&#x201D; field should be a short descriptive name, like
&#x201C;chromehangs analysis&#x201D;.</li>
<li>Upload your IPython notebook containing the analysis.</li>
<li>Set the number of workers of the cluster in the &#x201C;Cluster Size&#x201D;
field.</li>
<li>Set a schedule frequency using the remaining fields.</li>
</ol>
</li>
</ol>
<p>Now, the notebook will be updated automatically and the results can be
easily shared. Furthermore, all files stored in the notebook&apos;s local
working directory at the end of the job will be automatically uploaded
to S3, which comes in handy for simple ETL workloads for example.</p>
<p>For reference, see 
<a href="https://robertovitillo.com/2015/03/13/simple-dashboards-with-scheduled-spark-jobs-and-plotly" target="_blank">Simple Dashboard with Scheduled Spark Jobs and Plotly</a>.</p>
<h3 id="sharing-a-notebook"><a name="sharing-a-notebook" class="plugin-anchor" href="#sharing-a-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>Sharing a Notebook</h3>
<p>Jupyter notebooks can be shared in a few different ways.</p>
<h4 id="sharing-a-static-notebook"><a name="sharing-a-static-notebook" class="plugin-anchor" href="#sharing-a-static-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>Sharing a Static Notebook</h4>
<p>An easy way to share is using a gist on github.</p>
<ol>
<li>Download file as .ipynb</li>
<li>Upload to a gist on <a href="http://gist.github.com" target="_blank">gist.github.com</a></li>
<li>Enter the gist URL at <a href="http://nbviewer.jupyter.org/" target="_blank">Jupyter
nbviewer</a></li>
<li>Share with your colleagues!</li>
</ol>
<h4 id="sharing-a-scheduled-notebook"><a name="sharing-a-scheduled-notebook" class="plugin-anchor" href="#sharing-a-scheduled-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>Sharing a Scheduled Notebook</h4>
<p>Setup your scheduled notebook. After it&apos;s run, do the following:</p>
<ol>
<li>Go to the &apos;Schedule a Spark job&apos; tab in atmo</li>
<li>Get the URL for the notebook (under &apos;Currently Scheduled Jobs&apos;)</li>
<li>Paste that URL into <a href="http://nbviewer.jupyter.org/" target="_blank">Jupyter nbviewer</a></li>
</ol>
<h2 id="zeppelin-notebooks"><a name="zeppelin-notebooks" class="plugin-anchor" href="#zeppelin-notebooks"><i class="fa fa-link" aria-hidden="true"></i></a>Zeppelin Notebooks</h2>
<p>We also have *experimental* support for <a href="http://zeppelin.apache.org/" target="_blank">Apache
Zeppelin</a> notebooks. The notebook server
for that is running on port 8890, so you can connect to it just by
tunneling the port (instead of port 8888 for Jupyter). For example:</p>
<p>ssh -i ~/.ssh/id_rsa -L 8890:localhost:8890
hadoop@ec2-54-70-129-221.us-west-2.compute.amazonaws.com</p>
<h2 id="using-spark"><a name="using-spark" class="plugin-anchor" href="#using-spark"><i class="fa fa-link" aria-hidden="true"></i></a>Using Spark</h2>
<p>Spark is a general-purpose cluster computing system - it allows users to
run general execution graphs. APIs are available in Python, Scala, and
Java. The Jupyter notebook utilizes the Python API. In a nutshell, it
provides a way to run functional code (e.g. map, reduce, etc.) on large,
distributed data.</p>
<p>Check out 
<a href="https://robertovitillo.com/2015/06/30/spark-best-practices/" target="_blank">Spark Best Practices</a>
for tips on using Spark to it&apos;s full capabilities.</p>
<h3 id="sparkcontext-sc"><a name="sparkcontext-sc" class="plugin-anchor" href="#sparkcontext-sc"><i class="fa fa-link" aria-hidden="true"></i></a>SparkContext (sc)</h3>
<p>Access to the Spark API is provided through SparkContext. In the Jupyter
notebook, this is the `sc` object. For example, to create a
distributed RDD of monotonically increasing numbers 1-1000:</p>
<pre><code class="lang-python">numbers = range(<span class="hljs-number">1000</span>)
<span class="hljs-comment">#no need to initialize sc in the Jupyter notebook</span>
numsRdd = sc.parallelize(numbers)
nums.take(<span class="hljs-number">10</span>) <span class="hljs-comment">#no guaranteed order</span>
</code></pre>
<h3 id="spark-rdd"><a name="spark-rdd" class="plugin-anchor" href="#spark-rdd"><i class="fa fa-link" aria-hidden="true"></i></a>Spark RDD</h3>
<p>The Resilient Distributed Dataset (RDD) is Spark&apos;s basic data structure.
The operations that are performed on these structures are distributed to
the cluster. Only certain actions (such as collect() or take(N)) pull an
RDD in locally.</p>
<p>RDD&apos;s are nice because there is no imposed schema - whatever they
contain, they distribute around the cluster. Additionally, RDD&apos;s can be
cached in memory, which can greatly improve performance of some
algorithms that need access to data over and over again.</p>
<p>Additionally, RDD operations are all part of a directed, acyclic graph.
This gives increased redundancy, since Spark is always able to recreate
an RDD from the base data (by rerunning the graph), but also provides
lazy evaluation. No computation is performed while an RDD is just being
transformed (a la map), but when an action is taken (e.g. reduce, take)
the entire computation graph is evaluated. Continuing from our previous
example, the following gives some of the peaks of a sin wave:</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-comment">#no computation is performed on the following line!</span>
sin_values = numsRdd.map(<span class="hljs-keyword">lambda</span> x : np.float(x) / <span class="hljs-number">10</span>).map(<span class="hljs-keyword">lambda</span> x : (x, np.sin(x)))
<span class="hljs-comment">#now the entire computation graph is evaluated</span>
sin_values.takeOrdered(<span class="hljs-number">5</span>, <span class="hljs-keyword">lambda</span> x : -x[<span class="hljs-number">1</span>])
</code></pre>
<p>For jumping into working with Spark RDD&apos;s, we recommend reading the
<a href="https://spark.apache.org/docs/latest/programming-guide.html" target="_blank">Spark Programming Guide</a>.</p>
<h3 id="spark-sql-and-spark-dataframesdatasets"><a name="spark-sql-and-spark-dataframesdatasets" class="plugin-anchor" href="#spark-sql-and-spark-dataframesdatasets"><i class="fa fa-link" aria-hidden="true"></i></a>Spark SQL and Spark Dataframes/Datasets</h3>
<p>Spark also supports traditional SQL, along with special data structures
that require schemas. The Spark SQL API can be accessed with the
`spark` object. For example:</p>
<p><code>longitudinal = spark.sql(&apos;SELECT * FROM longitudinal&apos;)</code></p>
<p>creates a DataFrame that contains all the longitudinal data. A Spark
DataFrame is essentially a distributed table, a la Pandas or R
Dataframes. Under the covers they are an RDD of Row objects, and thus
the entirety of the RDD API is available for DataFrames, as well as a
DataFrame specific API. For example, a sql-like way to get the count of
a specific OS:</p>
<p><code>longitudinal.select(&quot;os&quot;).where(&quot;os = &apos;Darwin&apos;&quot;).count()</code></p>
<p>To Transform the DataFrame object to an RDD, simply do:</p>
<p><code>longitudinal_rdd = longitudinal.rdd</code></p>
<p>In general, however, the DataFrames are performance optimized, so it&apos;s
worth the effort to learn the DataFrame API.</p>
<p>For more overview, see the 
<a href="https://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank">SQL Programming Guide</a>.
See also the 
<a href="http://reports.telemetry.mozilla.org/post/tutorials/longitudinal_dataset.kp" target="_blank">Longitudinal Tutorial</a>,
one of the available example notebooks when you start a cluster.</p>
<h3 id="available-data-sources-for-sparksql"><a name="available-data-sources-for-sparksql" class="plugin-anchor" href="#available-data-sources-for-sparksql"><i class="fa fa-link" aria-hidden="true"></i></a>Available Data Sources for SparkSQL</h3>
<p>For information about available queryable data sources (e.g.  Longitudinal dataset), 
see 
<a href="../concepts/choosing_a_dataset.html">Choosing a Dataset</a>.</p>
<p>These datasets are optimized for fast access, and will far out-perform
analysis on the raw telemetry ping data.</p>
<h3 id="accessing-the-spark-ui"><a name="accessing-the-spark-ui" class="plugin-anchor" href="#accessing-the-spark-ui"><i class="fa fa-link" aria-hidden="true"></i></a>Accessing the Spark UI</h3>
<p>Go to <a href="https://localhost:8888/spark" target="_blank">https://localhost:8888/spark</a> after ssh-ing into the spark cluster
to see the Spark UI.
It has information about job statuses and task completion,
and may help you debug your job.</p>
<h2 id="the-moztelemetry-library"><a name="the-moztelemetry-library" class="plugin-anchor" href="#the-moztelemetry-library"><i class="fa fa-link" aria-hidden="true"></i></a>The MozTelemetry Library</h2>
<p>We have provided a library that gives easy access to the raw telemetry ping data.
For example usage, see the 
<a href="http://reports.telemetry.mozilla.org/post/tutorials/telemetry_hello_world.kp" target="_blank">Telemetry Hello World</a>
example notebook.
Detailed documentation for the library can be found at the 
<a href="http://python-moztelemetry.readthedocs.io" target="_blank">Python MozTelemetry Documentation</a>.</p>
<h3 id="using-the-raw-ping-data"><a name="using-the-raw-ping-data" class="plugin-anchor" href="#using-the-raw-ping-data"><i class="fa fa-link" aria-hidden="true"></i></a>Using the Raw Ping Data</h3>
<p>First off, import the moztelemetry library using the following:</p>
<p><code>from moztelemetry import get_pings</code></p>
<p>If you need any other functions, just comma separate them with
<code>get_pings</code>.</p>
<p>The ping data is an RDD of JSON elements. For example, using the
following:</p>
<pre><code class="lang-python">pings = get_pings(sc, app=<span class="hljs-string">&quot;Firefox&quot;</span>, channel=<span class="hljs-string">&quot;nightly&quot;</span>, build_id=(<span class="hljs-string">&quot;20160901000000&quot;</span>, <span class="hljs-string">&quot;20160901999999&quot;</span>), fraction=<span class="hljs-number">0.01</span>)
</code></pre>
<p>returns an RDD of 1/100th of Firefox Nightly JSON pings for all builds
from September 1 2016. Now, because it&apos;s JSON, pings are easy to access.
For example, to get the count of each OS type:</p>
<pre><code class="lang-python">os_names = pings.map(<span class="hljs-keyword">lambda</span> x : (x[<span class="hljs-string">&apos;environment&apos;</span>][<span class="hljs-string">&apos;system&apos;</span>][<span class="hljs-string">&apos;os&apos;</span>][<span class="hljs-string">&apos;name&apos;</span>], <span class="hljs-number">1</span>))`\
os_counts = os_names.reduceByKey(<span class="hljs-keyword">lambda</span> x, y : x+y)`\
os_counts.collect()`
</code></pre>
<p>Alternatively, moztelemetry provides the `get_pings_properties`
function, which will gather the data for you:</p>
<pre><code class="lang-python">subset = get_pings_properties(pings, [<span class="hljs-string">&quot;environment/system/os/name&quot;</span>])`\
subset.map(<span class="hljs-keyword">lambda</span> x : (x[<span class="hljs-string">&quot;environment/system/os/name&quot;</span>], <span class="hljs-number">1</span>)).reduceByKey(<span class="hljs-keyword">lambda</span> x, y : x+y).collect()`
</code></pre>
<h2 id="faq"><a name="faq" class="plugin-anchor" href="#faq"><i class="fa fa-link" aria-hidden="true"></i></a>FAQ</h2>
<p>Please add more FAQ as questions are answered by you or for you.</p>
<h3 id="how-can-i-load-parquet-datasets-in-a-jupyter-notebook"><a name="how-can-i-load-parquet-datasets-in-a-jupyter-notebook" class="plugin-anchor" href="#how-can-i-load-parquet-datasets-in-a-jupyter-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>How can I load parquet datasets in a Jupyter notebook?</h3>
<p>Use spark.read.parquet, e.g.:</p>
<pre><code class="lang-python">dataset = spark.read.parquet(<span class="hljs-string">&quot;s3://the_bucket/the_prefix/the_version&quot;</span>)`
</code></pre>
<p>For more information see
<a href="../cookbooks/parquet.html">Working with Parquet</a>.</p>
<h3 id="i-got-a-remote-host-identification-has-changed-error"><a name="i-got-a-remote-host-identification-has-changed-error" class="plugin-anchor" href="#i-got-a-remote-host-identification-has-changed-error"><i class="fa fa-link" aria-hidden="true"></i></a>I got a REMOTE HOST IDENTIFICATION HAS CHANGED! error</h3>
<p>AWS recycles hostnames, so this warning is expected.
Removing the offending key from $HOME/.ssh/known_hosts will remove the warning.
You can find the line to remove by finding the line in the output that says</p>
<p><code>Offending key in /path/to/hosts/known_hosts:2</code></p>
<p>Where 2 is the line number of the key that can be deleted.
Just remove that line, save the file, and try again.</p>
<h3 id="why-is-my-notebook-hanging"><a name="why-is-my-notebook-hanging" class="plugin-anchor" href="#why-is-my-notebook-hanging"><i class="fa fa-link" aria-hidden="true"></i></a>Why is my notebook hanging?</h3>
<p>There are a few common causes for this:</p>
<ol>
<li>Currently, our Spark notebooks can only run a single Python kernel at
a time. If you open multiple notebooks on the same cluster and try to
run both, the second notebook will hang. Be sure to close notebooks
using &quot;Close and Halt&quot; under the &quot;File&quot; dropdown.</li>
<li>The connection from PySpark to the Spark driver might be lost.
Unfortunately the best way to recover from this for the moment seems to
be spinning up a new cluster.</li>
<li>Canceling execution of a notebook cell doesn&apos;t cancel any spark jobs
that might be running in the background. If your spark commands seem to
be hanging, try running `sc.cancelAllJobs()`.</li>
</ol>
<h3 id="how-can-i-keep-running-after-closing-the-notebook"><a name="how-can-i-keep-running-after-closing-the-notebook" class="plugin-anchor" href="#how-can-i-keep-running-after-closing-the-notebook"><i class="fa fa-link" aria-hidden="true"></i></a>How can I keep running after closing the notebook?</h3>
<p>For long-running computation, it might be nice to close the notebook
(and the ssh session) and look at the results later.
Unfortunately, <strong>all cell output will be lost when a notebook is closed</strong>
(for the running cell).
To alleviate this, there are a few options:</p>
<ol>
<li>Have everything output to a variable. These values should still be
available when you reconnect.</li>
<li>Put %%capture at the beginning of the cell to store all output. 
<a href="https://ipython.org/ipython-doc/3/interactive/magics.html#cellmagic-capture" target="_blank">See the documentation</a>.</li>
</ol>
<h3 id="how-do-i-load-an-external-library-into-the-cluster"><a name="how-do-i-load-an-external-library-into-the-cluster" class="plugin-anchor" href="#how-do-i-load-an-external-library-into-the-cluster"><i class="fa fa-link" aria-hidden="true"></i></a>How do I load an external library into the cluster?</h3>
<p>Assuming you&apos;ve got a url for the repo, you can create an egg for it
this way:</p>
<pre><code class="lang-python">!git clone `&lt;repo url&gt;` &amp;&amp; cd `&lt;repo-name&gt;` &amp;&amp; python setup.py bdist_egg`\
sc.addPyFile(<span class="hljs-string">&apos;`&lt;repo-name&gt;`/dist/my-egg-file.egg&apos;</span>)`
</code></pre>
<p>Alternately, you could just create that egg locally, upload it to a web
server, then download and install it:</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> requests`\
r = requests.get(<span class="hljs-string">&apos;`&lt;url-to-my-egg-file&gt;`&apos;</span>)`\
<span class="hljs-keyword">with</span> open(<span class="hljs-string">&apos;mylibrary.egg&apos;</span>, <span class="hljs-string">&apos;wb&apos;</span>) <span class="hljs-keyword">as</span> f:`\
  f.write(r.content)`\
sc.addPyFile(<span class="hljs-string">&apos;mylibrary.egg&apos;</span>)`
</code></pre>
<p>You will want to do this <strong>before</strong> you load the library. If the library
is already loaded, restart the kernel in the ipython notebook.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../concepts/analysis_intro.html" class="navigation navigation-prev " aria-label="Previous page: Analysis Intro / TMO">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../cookbooks/realtime_analysis_plugin.html" class="navigation navigation-next " aria-label="Next page: Creating a Real-time Analysis Plugin">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Custom analysis with Spark","level":"1.4.2.2","depth":3,"next":{"title":"Creating a Real-time Analysis Plugin","level":"1.4.2.3","depth":3,"path":"cookbooks/realtime_analysis_plugin.md","ref":"cookbooks/realtime_analysis_plugin.md","articles":[]},"previous":{"title":"Analysis Intro / TMO","level":"1.4.2.1","depth":3,"path":"concepts/analysis_intro.md","ref":"concepts/analysis_intro.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["toc","anchors","ga"],"pluginsConfig":{"toc":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"ga":{"configuration":"auto","token":"UA-104326577-1"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"structure":{"langs":"LANGS.md","readme":"introduction.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"tools/spark.md","mtime":"2017-06-15T16:15:05.478Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-09-21T13:31:58.168Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

